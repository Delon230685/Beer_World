{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} | Hop & Barley{% endblock %}

{% block extra_css %}
<style>
  .quantity-selector {
    margin-bottom: 20px;
  }

  .quantity-selector label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #333;
  }

  .quantity-input-group {
    display: flex;
    align-items: center;
    max-width: 150px;
    margin-bottom: 5px;
  }

  .quantity-btn {
    width: 36px;
    height: 36px;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .quantity-btn:hover {
    background: #e0e0e0;
  }

  .quantity-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .quantity-input {
    width: 60px;
    height: 36px;
    text-align: center;
    border: 1px solid #ddd;
    border-left: none;
    border-right: none;
    font-size: 16px;
    -moz-appearance: textfield;
  }

  .quantity-input::-webkit-outer-spin-button,
  .quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  .stock-info {
    display: block;
    font-size: 14px;
    color: #666;
    margin-top: 5px;
  }

  .out-of-stock {
    padding: 15px;
    background: #fee;
    color: #c00;
    border-radius: 4px;
    font-weight: 500;
  }

  .cart-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #c00;
    color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cart-icon {
    position: relative;
  }

  .review-card {
    transition: transform 0.2s ease;
  }

  .review-card:hover {
    transform: translateY(-4px);
  }
</style>
{% endblock %}

{% block content %}
<!-- Product Title -->
<div class="product-header">
  <h1 class="product-title">{{ product.name }}</h1>
</div>

<!-- Main Content -->
<main class="page-product">
  <div class="container">
    <!-- Product Info Section -->
    <section class="product-details-section">
      <div class="product-image-container">
        {% if product.image %}
          <img src="{{ product.image.url }}" alt="{{ product.name }}" class="product-image">
        {% else %}
          <img src="{% static 'img/products/default_product.jpg' %}" alt="{{ product.name }}" class="product-image">
        {% endif %}
      </div>
      <div class="product-info-column">
        <div class="product-title-price">
          <h1 class="product-name">{{ product.name }}</h1>
          <div class="price-section">
            <span class="price-tag">per 100g</span>
            <p class="product-price">${{ product.price|floatformat:2 }}</p>
          </div>
        </div>
        <div class="product-description">
          <p>{{ product.description|linebreaksbr }}</p>
        </div>

        <!-- Container for managing the cart -->
        <div class="cart-controls">
          {% if product.stock > 0 %}
            <!-- Add to Cart form with quantity selector -->
            <form action="{% url 'orders:cart_add' product.id %}" method="post" id="add-to-cart-form">
              {% csrf_token %}

              <!-- ВИДИМЫЙ СЕЛЕКТОР КОЛИЧЕСТВА -->
              <div class="quantity-selector">
                <label for="quantity">Quantity:</label>
                <div class="quantity-input-group">
                  <button type="button" class="quantity-btn" data-action="decrease" id="decrease-btn">−</button>
                  <input type="number" name="quantity" id="quantity" value="1" min="1" max="{{ product.stock }}" class="quantity-input">
                  <button type="button" class="quantity-btn" data-action="increase" id="increase-btn">+</button>
                </div>
                <span class="stock-info">Available: {{ product.stock }}</span>
              </div>

              <button type="submit" class="button button--primary add-to-cart-button" id="add-to-cart-btn">
                <i class="fa-solid fa-cart-shopping"></i>
                <span>Add to Cart</span>
              </button>
            </form>
          {% else %}
            <div class="out-of-stock">Out of Stock</div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Technical Specifications Accordion -->
    <section class="accordion-section">
      <div class="accordion-item">
        <div class="accordion-title">
          <h3>Technical Specifications</h3>
          <i class="fa-solid fa-chevron-down accordion-icon"></i>
        </div>
        <div class="accordion-content">
          <ul>
            <li><strong>Category:</strong> {{ product.category.name|default:"Not specified" }}</li>
            {% if product.specifications %}
              {{ product.specifications|safe }}
            {% else %}
              <li><strong>Origin:</strong> Imported</li>
              <li><strong>Type:</strong> Premium quality</li>
            {% endif %}
          </ul>
        </div>
      </div>
    </section>

    <!-- Latest Reviews Section -->
    <section class="reviews-section">
      <h2 class="reviews-title">Latest reviews</h2>
      <div class="reviews-grid">
        {% if product.reviews.all %}
          {% for review in product.reviews.all|slice:":3" %}
            <div class="review-card">
              <div class="review-rating">
                {% for i in "12345"|make_list %}
                  {% if forloop.counter <= review.rating %}
                    <i class="fa-solid fa-star"></i>
                  {% else %}
                    <i class="fa-regular fa-star"></i>
                  {% endif %}
                {% endfor %}
              </div>
              <div class="review-body">
                <h4 class="review-heading">Review {{ forloop.counter }}</h4>
                <p class="review-text">{{ review.text|truncatewords:20 }}</p>
              </div>
              <div class="review-author">
                <img src="{% static 'img/avatars/avatar1.svg' %}" alt="User avatar" class="author-avatar">
                <span class="author-name">{{ review.user.username|default:"Customer" }}</span>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <!-- Static fallback reviews -->
          <div class="review-card">
            <div class="review-rating">
              <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
            </div>
            <div class="review-body">
              <h4 class="review-heading">Great product!</h4>
              <p class="review-text">Excellent quality and fast shipping. Will buy again!</p>
            </div>
            <div class="review-author">
              <img src="{% static 'img/avatars/avatar1.svg' %}" alt="User avatar" class="author-avatar">
              <span class="author-name">Customer</span>
            </div>
          </div>
          <div class="review-card">
            <div class="review-rating">
              <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i>
            </div>
            <div class="review-body">
              <h4 class="review-heading">Good value</h4>
              <p class="review-text">Works as expected, good quality for the price.</p>
            </div>
            <div class="review-author">
              <img src="{% static 'img/avatars/avatar2.svg' %}" alt="User avatar" class="author-avatar">
              <span class="author-name">BeerLover</span>
            </div>
          </div>
          <div class="review-card">
            <div class="review-rating">
              <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i>
            </div>
            <div class="review-body">
              <h4 class="review-heading">Average</h4>
              <p class="review-text">Not bad, but expected more.</p>
            </div>
            <div class="review-author">
              <img src="{% static 'img/avatars/avatar3.svg' %}" alt="User avatar" class="author-avatar">
              <span class="author-name">Homebrewer</span>
            </div>
          </div>
        {% endif %}
      </div>
    </section>
  </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Элементы управления количеством
  const quantityInput = document.getElementById('quantity');
  const decreaseBtn = document.getElementById('decrease-btn');
  const increaseBtn = document.getElementById('increase-btn');
  const addToCartForm = document.getElementById('add-to-cart-form');

  if (quantityInput && decreaseBtn && increaseBtn) {
    const maxStock = parseInt(quantityInput.max) || 999;

    // Уменьшение количества
    decreaseBtn.addEventListener('click', function() {
      let currentValue = parseInt(quantityInput.value) || 1;
      if (currentValue > 1) {
        quantityInput.value = currentValue - 1;
      }
    });

    // Увеличение количества
    increaseBtn.addEventListener('click', function() {
      let currentValue = parseInt(quantityInput.value) || 1;
      if (currentValue < maxStock) {
        quantityInput.value = currentValue + 1;
      }
    });

    // Валидация при ручном вводе
    quantityInput.addEventListener('change', function() {
      let value = parseInt(this.value);
      if (isNaN(value) || value < 1) {
        this.value = 1;
      } else if (value > maxStock) {
        this.value = maxStock;
      }
    });

    // Блокировка кнопок при достижении лимитов
    function updateButtons() {
      let currentValue = parseInt(quantityInput.value) || 1;
      decreaseBtn.disabled = currentValue <= 1;
      increaseBtn.disabled = currentValue >= maxStock;
    }

    quantityInput.addEventListener('input', updateButtons);
    decreaseBtn.addEventListener('click', updateButtons);
    increaseBtn.addEventListener('click', updateButtons);
    updateButtons();
  }

  // AJAX добавление в корзину
  if (addToCartForm) {
    addToCartForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const formData = new FormData(this);
      const quantity = formData.get('quantity');

      fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          alert(`Added ${quantity} item(s) to cart!`);

          // Обновляем иконку корзины с счетчиком
          const cartIcon = document.querySelector('.cart-icon');
          if (cartIcon) {
            // Удаляем старый badge если есть
            const oldBadge = cartIcon.querySelector('.cart-badge');
            if (oldBadge) oldBadge.remove();

            // Добавляем новый badge с количеством
            if (data.cart_items_count > 0) {
              const badge = document.createElement('span');
              badge.className = 'cart-badge';
              badge.textContent = data.cart_items_count;
              cartIcon.appendChild(badge);
            }
          }
        } else {
          alert(data.message);
        }
      })
      .catch(error => console.error('Error:', error));
    });
  }

  // Аккордеон для технических спецификаций
  const accordionTitle = document.querySelector('.accordion-title');
  const accordionItem = document.querySelector('.accordion-item');

  if (accordionTitle && accordionItem) {
    accordionTitle.addEventListener('click', function() {
      accordionItem.classList.toggle('active');
    });
  }
});
</script>
{% endblock %}